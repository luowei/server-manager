# 服务器管理系统 (Server Manager) - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品定位
服务器管理系统是一个基于Web的统一管理平台，专注于提供局域网设备的远程唤醒(WOL)和自动化任务调度功能。产品面向系统管理员、开发者和技术爱好者，旨在简化多设备环境下的管理工作。

### 1.2 核心价值
- **设备管理自动化**: 通过WOL技术实现远程设备启动管理
- **任务调度智能化**: 提供灵活的定时任务调度和执行监控
- **操作界面现代化**: 响应式设计，支持深色模式，优秀的用户体验
- **部署方式灵活化**: 支持Docker容器化部署和传统部署方式

### 1.3 目标用户
- **主要用户**: 系统管理员、DevOps工程师、网络管理员
- **次要用户**: 开发者、技术爱好者、小团队IT负责人
- **使用场景**: 家庭实验室、小型办公网络、开发测试环境

## 2. 功能需求

### 2.1 WOL设备管理模块

#### 2.1.1 设备信息管理
**功能描述**: 提供完整的网络设备信息管理功能

**具体需求**:
- 设备基础信息录入（名称、描述、MAC地址、IP/主机名）
- 支持多种地址格式：IP地址、CIDR格式、主机名、mDNS域名
- 地址类型智能识别和视觉区分（颜色+图标）
- 设备信息的增删查改操作

**验收标准**:
- ✅ 支持mDNS格式（.local、.lan）设备添加
- ✅ CIDR格式IP地址自动解析
- ✅ 地址类型视觉区分（绿色+📡、蓝色+🖥️、紫色+🔌）
- ✅ 表单验证和错误提示

#### 2.1.2 设备状态监控
**功能描述**: 实时监控设备在线状态

**具体需求**:
- 多策略设备状态检测（ICMP ping + TCP端口检测）
- 设备状态实时显示（在线/离线）
- 自动状态刷新机制
- Docker容器友好的检测实现

**验收标准**:
- ✅ 优先TCP端口检测，回退ICMP ping
- ✅ Docker容器中权限问题解决
- ✅ mDNS域名解析支持
- ✅ 状态更新不超过5秒延迟

#### 2.1.3 远程唤醒功能
**功能描述**: 通过WOL协议远程唤醒设备

**具体需求**:
- WOL魔术包发送功能
- 支持广播和单播两种模式
- 发送结果反馈和状态跟踪
- 批量唤醒支持

**验收标准**:
- ✅ WOL包成功发送率>95%
- ✅ 支持跨网段WOL
- ✅ 发送结果即时反馈
- ✅ 操作日志记录

### 2.2 定时任务管理模块

#### 2.2.1 任务创建和配置
**功能描述**: 提供灵活的任务创建和调度配置功能

**具体需求**:
- Shell脚本任务支持，集成代码编辑器
- 多种调度方式：Cron表达式、间隔时间、手动执行
- 任务启用/禁用状态管理
- 任务参数和环境配置

**验收标准**:
- ✅ CodeMirror编辑器集成，支持语法高亮
- ✅ Cron表达式验证和预览
- ✅ 任务配置持久化存储
- ✅ 任务状态二态切换（启用/禁用）

#### 2.2.2 任务执行和监控
**功能描述**: 任务执行引擎和实时监控功能

**具体需求**:
- 基于APScheduler的任务调度引擎
- 任务执行状态实时跟踪
- 执行日志详细记录
- 任务超时和重试机制

**验收标准**:
- ✅ 任务执行成功率>98%
- ✅ 执行状态实时更新
- ✅ 完整的执行日志（stdout/stderr/退出码）
- ✅ 超时保护机制

#### 2.2.3 执行记录管理
**功能描述**: 任务执行历史的查询和管理功能

**具体需求**:
- 执行记录搜索和过滤
- 多维度排序（时间、任务名、状态）
- 批量删除和清理功能
- 执行日志详细查看

**验收标准**:
- ✅ 支持关键词搜索
- ✅ 多字段排序组合
- ✅ 智能删除按钮（删除结果/清空所有）
- ✅ 日志查看模态框优化

### 2.3 Web界面和用户体验

#### 2.3.1 响应式设计
**功能描述**: 适配多种屏幕尺寸的响应式界面

**具体需求**:
- 桌面端和移动端界面优化
- 断点适配和布局调整
- 触摸友好的交互设计
- 移动端专用导航

**验收标准**:
- ✅ 支持320px-2560px宽度屏幕
- ✅ 移动端底部导航栏
- ✅ 触摸手势支持
- ✅ 布局无横向滚动条

#### 2.3.2 主题系统
**功能描述**: 完整的3选项主题切换系统

**具体需求**:
- 亮色/自动/暗色三种主题模式
- 自动跟随系统主题设置
- 主题设置localStorage持久化
- 全界面元素主题支持

**验收标准**:
- ✅ 3选项主题选择器（emoji图标）
- ✅ 系统主题变化自动响应
- ✅ 主题设置跨会话保存
- ✅ 所有UI组件主题一致性

#### 2.3.3 性能优化
**功能描述**: 页面加载和交互性能优化

**具体需求**:
- 智能轮询和请求缓存
- 防抖动机制减少重复请求
- 静态资源加载优化
- 数据库查询性能优化

**验收标准**:
- ✅ 页面加载时间<2秒
- ✅ 接口响应时间<500ms
- ✅ 网络请求数减少50%
- ✅ 数据库查询优化70%

### 2.4 系统管理功能

#### 2.4.1 系统状态监控
**功能描述**: 系统运行状态的实时监控

**具体需求**:
- 系统资源监控（CPU、内存、磁盘）
- 任务调度器状态监控
- 数据库统计信息
- 应用运行时状态

**验收标准**:
- ✅ 系统资源使用率准确显示
- ✅ 任务统计信息实时更新
- ✅ 状态更新频率60秒
- ✅ 异常状态告警显示

#### 2.4.2 日志管理
**功能描述**: 应用日志的管理和维护功能

**具体需求**:
- 日志级别配置（DEBUG/INFO/WARNING/ERROR）
- 日志文件轮转和清理
- 在线日志查看功能
- 日志搜索和过滤

**验收标准**:
- ✅ 日志自动轮转（按大小/时间）
- ✅ 旧日志自动清理（默认30天）
- ✅ 日志格式结构化
- ✅ 关键操作审计日志

## 3. 技术架构

### 3.1 后端架构
- **Web框架**: FastAPI + Uvicorn
- **数据存储**: TinyDB + 自定义YAML存储
- **任务调度**: APScheduler
- **网络功能**: asyncio + socket编程
- **部署方式**: Docker容器化

### 3.2 前端架构
- **UI框架**: Bootstrap 5 + 原生JavaScript
- **主题系统**: CSS变量 + localStorage
- **代码编辑**: CodeMirror
- **图标系统**: Bootstrap Icons
- **性能优化**: 防抖动 + 智能轮询

### 3.3 数据模型

#### 3.3.1 WOL设备模型
```python
class WOLDevice:
    id: int
    name: str
    hostname: Optional[str]
    ip_address: Optional[str]
    mac_address: str
    description: Optional[str]
    created_at: datetime
    updated_at: datetime
```

#### 3.3.2 定时任务模型
```python
class ScheduledTask:
    id: int
    name: str
    command: str
    cron_expr: Optional[str]
    interval_seconds: Optional[int]
    enabled: bool = True
    created_at: datetime
    updated_at: datetime
    last_run_at: Optional[datetime]
    next_run_at: Optional[datetime]
```

#### 3.3.3 执行记录模型
```python
class TaskExecution:
    id: int
    task_id: int
    task_name: str
    command: str
    status: TaskStatus
    started_at: Optional[datetime]
    completed_at: Optional[datetime]
    exit_code: Optional[int]
    stdout: Optional[str]
    stderr: Optional[str]
    error_message: Optional[str]
```

## 4. 部署和配置

### 4.1 Docker部署（推荐）
- **镜像仓库**: GitHub Container Registry + Docker Hub
- **网络模式**: Host模式（完整功能）+ Bridge模式（兼容性）
- **权限配置**: NET_RAW + NET_ADMIN
- **数据持久化**: Volume映射

### 4.2 传统部署
- **Python版本**: 3.7+
- **依赖管理**: requirements.txt
- **配置方式**: 命令行参数 + 环境变量
- **进程管理**: systemd/supervisor

### 4.3 环境配置
```bash
# 核心配置
SM_PORT=8000                    # Web服务端口
SM_LOG_LEVEL=INFO              # 日志级别
SM_ENV=production              # 运行环境
TZ=Asia/Shanghai               # 时区设置

# WOL配置
SM_WOL_PORT=9                  # WOL端口
SM_WOL_TIMEOUT=3               # 超时时间

# 任务配置
SM_TASK_TIMEOUT=300            # 任务超时
SM_LOG_RETENTION_DAYS=30       # 日志保留期
```

## 5. 安全和质量保证

### 5.1 安全策略
- **CSP策略**: Content Security Policy配置
- **输入验证**: 所有用户输入严格验证
- **权限控制**: 最小权限原则
- **数据保护**: 敏感信息不记录到日志

### 5.2 质量保证
- **代码质量**: 类型提示 + Pydantic验证
- **错误处理**: 完整的异常捕获和处理
- **日志记录**: 结构化日志和审计跟踪
- **性能监控**: 关键指标监控

### 5.3 测试策略
- **单元测试**: 核心业务逻辑测试覆盖
- **集成测试**: API接口功能验证
- **性能测试**: 负载和压力测试
- **兼容性测试**: 多平台和浏览器测试

## 6. 路线图和未来规划

### 6.1 短期目标（v1.4.0）
- [ ] 设备分组管理功能
- [ ] 任务模板和任务链
- [ ] 更多通知方式（邮件、Webhook）
- [ ] 批量操作增强

### 6.2 中期目标（v2.0.0）
- [ ] 多用户和权限管理
- [ ] 设备监控告警系统
- [ ] 任务依赖和工作流
- [ ] 插件系统架构

### 6.3 长期目标（v3.0.0）
- [ ] 分布式架构支持
- [ ] 云端同步功能
- [ ] 移动端原生应用
- [ ] AI辅助运维功能

## 7. 成功指标

### 7.1 用户体验指标
- 页面加载时间 < 2秒
- 操作响应时间 < 500ms
- 界面错误率 < 1%
- 用户满意度 > 4.5/5

### 7.2 系统性能指标
- 系统可用性 > 99.9%
- WOL成功率 > 95%
- 任务执行成功率 > 98%
- 资源利用率 < 80%

### 7.3 业务指标
- 月活跃用户增长 > 20%
- 功能使用覆盖率 > 80%
- 问题反馈响应时间 < 24小时
- 用户留存率 > 85%

---

**文档版本**: v1.3.0  
**更新时间**: 2025-09-08  
**负责人**: Server Manager Team  
**审核状态**: 已审核